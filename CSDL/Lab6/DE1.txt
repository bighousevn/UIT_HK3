-----------DE 1--------------

CREATE DATABASE BAITHI
USE BAITHI

CREATE TABLE CSCHANNUOI
(
	MACS VARCHAR(5),
	TENCS VARCHAR(50),
	LOAICS VARCHAR(50),
	NGDAIDIEN VARCHAR(50),
	NGTL SMALLDATETIME,
	DTHOAI VARCHAR(30),
	CONSTRAINT PK_CSCN PRIMARY KEY (MACS)
)

CREATE TABLE GIONGVN
(
	MAGIONG VARCHAR(4),
	TENGIONG VARCHAR(50),
	LOAIVN VARCHAR(50),
	CONSTRAINT PK_GVN PRIMARY KEY (MAGIONG)
)

CREATE TABLE DIEUKIENCN
(
	MADK VARCHAR(5),
	MACS VARCHAR(5),
	QUYMO INT,
	KCXLCT INT,
	KCKDC INT,
	CONSTRAINT PK_DKCN PRIMARY KEY (MADK, MACS)
)

CREATE TABLE GPCN
(
	MAGP VARCHAR(5),
	MACS VARCHAR(5),
	NGCAP SMALLDATETIME,
	SOGP VARCHAR(100),
	SOGIONG INT,
	CONSTRAINT PK_GPCN PRIMARY KEY (MAGP)
)

CREATE TABLE CTGP
(
	MAGP VARCHAR(5),
	MAGIONG VARCHAR(4),
	SL INT,
	CONSTRAINT PK_CTGP PRIMARY KEY (MAGP, MAGIONG)
)

CREATE TABLE DOTCN
(
	MADOTCN VARCHAR(4),
	MACS VARCHAR(5),
	MAGIONG VARCHAR(4),
	SLVN INT, 
	NGBD SMALLDATETIME,
	PHGTHUC VARCHAR(50),
	NGXUATDK SMALLDATETIME,
	CONSTRAINT PK_DCN PRIMARY KEY (MADOTCN)
)

INSERT INTO CSCHANNUOI VALUES
('CS001', 'Hoang mai', 'Nong ho', 'Nguyen Thanh Son', '10/19/2019', '0971507394'),
('CS002', 'Cong ty TNHH Phung Dầu Sơn', 'Trang trai quy mo vua', 'Pham The Hung', '10/20/2009', '0364266792'),
('CS003', 'Green Farm', 'Trang trai quy mo nho', 'Ho Trung Dai', '09/15/2018', '0356266782')

INSERT INTO GIONGVN VALUES
('G001', 'Bo vang Viet Nam', 'Bo'),
('G002', 'Bo Bay Nui', 'Bo'),
('G003', 'De nui Ninh Binh', 'De')

INSERT INTO DIEUKIENCN VALUES
('DK001', 'CS001', 10, 250, 300),
('DK002', 'CS001', 10, 200, 350),
('DK003', 'CS003', 30, 350, 400)

INSERT INTO GPCN VALUES
('GP001', 'CS001', '10/10/2020', '42/001/2020/DKCN', 1),
('GP002', 'CS001', '09/08/2020', '43/001/2020/DKCN', 2),
('GP003', 'CS002', '06/04/2010', '2/002/2010/DKCN', 4)

INSERT INTO CTGP VALUES
('GP001', 'G001', 10),
('GP002', 'G002', 10),
('GP002', 'G003', 10)

INSERT INTO DOTCN VALUES
('D001', 'CS001', 'G001', 5, '06/15/2021', 'Tha tu do', '05/15/2023'),
('D002', 'CS001', 'G002', 5, '07/15/2021', 'Tha tu do', '05/10/2023'),
('D003', 'CS003', 'G001', 25, '09/20/2021', 'Tha tu do', '03/10/2022')

ALTER TABLE DIEUKIENCN ADD
CONSTRAINT FK_DKCN_CSCN FOREIGN KEY (MACS) REFERENCES CSCHANNUOI(MACS)

ALTER TABLE GPCN ADD
CONSTRAINT FK_GPCN_CSCN FOREIGN KEY (MACS) REFERENCES CSCHANNUOI(MACS)

ALTER TABLE CTGP ADD 
CONSTRAINT FK_CTGP_GPCN FOREIGN KEY (MAGP) REFERENCES GPCN(MAGP),
CONSTRAINT FK_CTGP_GVN FOREIGN KEY (MAGIONG) REFERENCES GIONGVN(MAGIONG)

ALTER TABLE DOTCN ADD
CONSTRAINT FK_DCN_CSCN FOREIGN KEY (MACS) REFERENCES CSCHANNUOI(MACS),
CONSTRAINT FK_DCN_GVN FOREIGN KEY (MAGIONG) REFERENCES GIONGVN(MAGIONG)


---3. Hiện thực ràng buộc toàn vẹn sau: số lượng vật nuôi từ 100 trở lên không được phép chăn nuôi theo phương thức “thả tự do” (1đ).
ALTER TABLE DOTCN ADD
CONSTRAINT CK_SLVN
CHECK (SLVN < 100 OR PHGTHUC <> 'Tha tu do')
GO

---4. Hiện thực ràng buộc toàn vẹn sau: các giống của loại vật nuôi "Bo" có thời gian xuất dự kiến cách ngày bắt đầu nuôi ít nhất 12 tháng (1.5đ).
CREATE TRIGGER trg_insert_update_dcn ON DOTCN
FOR INSERT, UPDATE
AS
BEGIN	
	 IF EXISTS (SELECT *
				FROM inserted I, GIONGVN G
				WHERE I.MAGIONG = G.MAGIONG AND G.LOAIVN = 'Bo'	AND (DATEDIFF(MONTH, NGBD, NGXUATDK) < 12))
	 BEGIN 
		RAISERROR('LOI', 16, 1)
		ROLLBACK TRANSACTION
	END
END
GO

CREATE TRIGGER trg_update_gvn ON GIONGVN
FOR UPDATE
AS 
BEGIN
	IF EXISTS (SELECT *
			   FROM inserted I, DOTCN D
			   WHERE I.MAGIONG = D.MAGIONG AND LOAIVN = 'Bo' AND (DATEDIFF(MONTH, NGBD, NGXUATDK) < 12))
	BEGIN
		RAISERROR('LOI', 16, 1)
		ROLLBACK TRANSACTION
	END
END

---5. Tìm các giống vật nuôi (MAGIONG, TENGIONG) thuộc loại “Bo” được chăn nuôi theo phương thức “thả tự do” dự kiến xuất trong tháng 12/2024 (1đ).
SELECT G.MAGIONG, TENGIONG
FROM GIONGVN G, DOTCN D
WHERE G.MAGIONG = D.MAGIONG AND LOAIVN = 'Bo' AND PHGTHUC = 'Tha tu do' AND YEAR(NGXUATDK) = 2024 AND MONTH(NGXUATDK) = 12
---6. Tìm cơ sở chăn nuôi (MACS, TENCS) chưa có giấy phép chăn nuôi nào được cấp cho giống vật nuôi thuộc loại “De” nhưng đã từng có đợt chăn nuôi các giống vật nuôi loại này trong năm 2024 (1đ).
SELECT CS1.MACS, TENCS
FROM CSCHANNUOI CS1
WHERE CS1.MACS NOT IN (SELECT CS2.MACS
					   FROM CSCHANNUOI CS2, GPCN GP, GIONGVN G, CTGP CT
				       WHERE CS2.MACS = GP.MACS AND GP.MAGP = CT.MAGP AND CT.MAGIONG = G.MAGIONG AND LOAIVN = 'De')
	  AND CS1.MACS IN (SELECT MACS
					   FROM DOTCN D, GIONGVN G
					   WHERE D.MAGIONG = G.MAGIONG AND LOAIVN = 'De' AND YEAR(NGBD) = 2024)
---7. Tính thời gian nuôi thực tế trung bình (theo đơn vị tháng) của từng loại vật nuôi theo từng hình thức chăn nuôi (1đ).
SELECT LOAIVN, PHGTHUC, AVG(DATEDIFF(MONTH, NGBD, NGXUATDK)) AS TGTB
FROM GIONGVN G, DOTCN D
WHERE G.MAGIONG = D.MAGIONG
GROUP BY LOAIVN, PHGTHUC
---8. Với từng loại vật nuôi tìm giống vật nuôi(MAGIONG) từng được cấp phép với tổng số lượng nhiều nhất năm 2024 (1đ).
SELECT G1.MAGIONG, LOAIVN
FROM GIONGVN G1
WHERE G1.MAGIONG IN (SELECT TOP 1 WITH TIES G2.MAGIONG
					 FROM GIONGVN G2, CTGP CT, GPCN GP
					 WHERE G2.MAGIONG = CT.MAGIONG AND GP.MAGP = CT.MAGP AND YEAR(NGCAP) = 2024 AND G2.LOAIVN = G1.LOAIVN
					 GROUP BY G2.MAGIONG
					 ORDER BY SUM(SL) DESC)
---9. Tìm cơ sở chăn nuôi (MACS, TENCS) đã được cấp phép chăn nuôi tất cả các giống của loại vật nuôi “Bo” với số lượng mỗi giống đều từ 20 trở lên (1đ).
SELECT CS.MACS, TENCS
FROM CSCHANNUOI CS
WHERE NOT EXISTS (SELECT *
				  FROM GIONGVN G
				  WHERE LOAIVN = 'Bo' AND NOT EXISTS (SELECT *
													  FROM CTGP CT INNER JOIN GPCN GP ON GP.MAGP = CT.MAGP
													  WHERE CT.MAGIONG = G.MAGIONG AND GP.MACS = CS.MACS 
															AND SL >= 20))

-----------------DE 2-------------------
CREATE TABLE BAITHI
USE BAITHI

CREATE TABLE CSCHANNUOI
(
	MACS VARCHAR(5),
	TENCS VARCHAR(50),
	LOAICS VARCHAR(50),
	NGDAIDIEN VARCHAR(50),
	NGTL SMALLDATETIME,
	DTHOAI VARCHAR(30),
	CONSTRAINT PK_CSCN PRIMARY KEY (MACS)
)

CREATE TABLE GIONGVN
(
	MAGIONG VARCHAR(4),
	TENGIONG VARCHAR(50),
	LOAIVN VARCHAR(50),
	CONSTRAINT PK_GVN PRIMARY KEY (MAGIONG)
)

CREATE TABLE DIEUKIENCN
(
	MADK VARCHAR(5),
	MACS VARCHAR(5),
	QUYMO INT,
	KCXLCT INT,
	KCHTNSH INT,
	CONSTRAINT PK_DKCN PRIMARY KEY (MADK, MACS)
)

CREATE TABLE GPCN
(
	MAGP VARCHAR(5),
	MACS VARCHAR(5),
	NGCAP SMALLDATETIME,
	SOGP VARCHAR(100),
	SOGIONG INT,
	CONSTRAINT PK_GPCN PRIMARY KEY (MAGP)
)

CREATE TABLE CTGP
(
	MAGP VARCHAR(5),
	MAGIONG VARCHAR(4),
	SL INT,
	CONSTRAINT PK_CTGP PRIMARY KEY (MAGP, MAGIONG)
)

CREATE TABLE DOTCN
(
	MADOTCN VARCHAR(4),
	MACS VARCHAR(5),
	MAGIONG VARCHAR(4),
	SLVN INT, 
	NGBD SMALLDATETIME,
	PHGTHUC VARCHAR(50),
	NGXUATDK SMALLDATETIME,
	CONSTRAINT PK_DCN PRIMARY KEY (MADOTCN)
)

ALTER TABLE DOTCN ADD
CONSTRAINT FK_DCN_CSCN FOREIGN KEY (MACS) REFERENCES CSCHANNUOI(MACS),  
CONSTRAINT FK_DCN_GVN FOREIGN KEY (MAGIONG) REFERENCES GIONGVN(MAGIONG)

ALTER TABLE GPCN ADD
CONSTRAINT FK_GP_CSCN FOREIGN KEY (MACS) REFERENCES CSCHANNUOI(MACS) 

ALTER TABLE CTGP ADD 
CONSTRAINT FK_CTGP_GP FOREIGN KEY (MAGP) REFERENCES GPCN(MAGP),  
CONSTRAINT FK_CTGP_GVN FOREIGN KEY (MAGIONG) REFERENCES GIONGVN(MAGIONG)

ALTER TABLE DIEUKIENCN ADD
CONSTRAINT FK_DK_CSCN FOREIGN KEY (MACS) REFERENCES CSCHANNUOI(MACS)  

INSERT INTO CSCHANNUOI (MACS, TENCS, LOAICS, NGDAIDIEN, NGTL, DTHOAI) VALUES
('CS001', 'Tam Viet', 'Nong ho', 'Bui Phu Lam', '2018-10-19', '0971507142'),
('CS002', 'Cam My', 'Trang trai quy mo vua', 'Le Thi Hong Tuyet', '2008-10-20', '0364266762'),
('CS003', 'Me Non', 'Trang trai quy mo nho', 'Ngo Van Thanh', '2017-09-15', '0356266967');

INSERT INTO GIONGVN (MAGIONG, TENGIONG, LOAIVN) VALUES
('G001', 'Heo ba xuyen', 'Heo'),
('G002', 'Heo moi', 'Heo'),
('G003', 'Bo lai Sind', 'Bo');

INSERT INTO DIEUKIENCN (MADK, MACS, QUYMO, KCXLCT, KCHTNSH) VALUES
('DK001', 'CS001', 10, 250, 350),
('DK002', 'CS001', 10, 200, 400),
('DK003', 'CS003', 30, 350, 450);

INSERT INTO GPCN (MAGP, MACS, NGCAP, SOGP, SOGIONG) VALUES
('GP001', 'CS001', '2019-10-10', '42/001/2019/DKCN', 1),
('GP002', 'CS001', '2019-09-08', '43/001/2019/DKCN', 2),
('GP003', 'CS002', '2009-06-04', '2/002/2009/DKCN', 4);

INSERT INTO CTGP VALUES
('GP001', 'G001', 10),
('GP002', 'G002', 10),
('GP002', 'G003', 10)

INSERT INTO DOTCN VALUES
('D001', 'CS001', 'G001', 5, '06/15/2021', 'Nuoi cong nghiep', '09/15/2021'),
('D002', 'CS001', 'G002', 5, '07/15/2021', 'Tha tu do', '01/10/2022'),
('D003', 'CS003', 'G001', 25, '09/20/2021', 'Tha tu do', '08/10/2023')

---3. Hiện thực ràng buộc toàn vẹn sau: các giấy phép được cấp trước năm 2019 có số giống được cấp phép tối đa 5 giống một lần cấp (1đ).
ALTER TABLE GPCN ADD
CONSTRAINT CK_GPCN
CHECK (SOGIONG > 5 OR NGCAP >= '01/01/2019')  
GO
---4. Hiện thực ràng buộc toàn vẹn sau: các giống vật nuôi loại "Heo" chỉ được cấp giấy phép chăn nuôi với số lượng tối đa là 100 vật nuôi (1.5đ).
CREATE TRIGGER trg_insert_update_ctgp ON CTGP
FOR INSERT, UPDATE
AS 
BEGIN
	IF EXISTS (SELECT *
			   FROM inserted I, GIONGVN G
			   WHERE I.MAGIONG = G.MAGIONG AND LOAIVN = 'Heo' AND SL > 100)
	BEGIN
		RAISERROR('LOI > 100', 16, 1)
		ROLLBACK TRANSACTION
	END
END
GO

CREATE TRIGGER trg_update_gvn ON GIONGVN
FOR UPDATE
AS
BEGIN
	IF EXISTS (SELECT *
			   FROM inserted I, CTGP CT
			   WHERE I.MAGIONG = CT.MAGIONG AND SL > 100 AND I.LOAIVN = 'Heo')
	BEGIN
		RAISERROR('LOI > 100', 16, 1)
		ROLLBACK TRANSACTION
	END
END

---5. Tìm các cơ sở chăn nuôi (MACS, TENCS) thuộc loại “nong ho” có quy mô trên 30 vật nuôi và có khoảng cách đến khu xử lý chất thải dưới 200 mét (1đ).
SELECT CS.MACS, TENCS
FROM CSCHANNUOI CS, DIEUKIENCN DK
WHERE CS.MACS = DK.MACS AND LOAICS = 'Nong ho'AND QUYMO > 30 AND KCXLCT < 200
---6. Tìm các giống vật nuôi (MAGIONG, TENGIONG) thuộc loại “Bo” đã từng được cấp phép chăn nuôi nhưng chưa được nuôi đợt nào năm 2024 (1đ).
SELECT G1.MAGIONG, TENGIONG
FROM GIONGVN G1
WHERE G1.MAGIONG IN (SELECT G2.MAGIONG
					 FROM GIONGVN G2, CTGP CT
					 WHERE G2.MAGIONG = CT.MAGIONG AND LOAIVN =  'Bo')
	  AND G1.MAGIONG NOT IN (SELECT G.MAGIONG
							 FROM GIONGVN G, DOTCN D
							 WHERE G.MAGIONG = D.MAGIONG AND YEAR(NGBD) = 2024 AND LOAIVN = 'Bo')

---7. Tính thời gian nuôi thực tế dài nhất (theo đơn vị tháng) của từng loại vật nuôi theo từng hình thức chăn nuôi (1đ).
SELECT LOAIVN, PHGTHUC, MAX(DATEDIFF(MONTH, NGBD, NGXUATDK))
FROM GIONGVN G, DOTCN D
WHERE G.MAGIONG = D.MAGIONG
GROUP BY LOAIVN, PHGTHUC

---8. Với từng loại vật nuôi tìm giống vật nuôi (MAGIONG) từng được chăn nuôi với tổng số lượng nuôi thực tế nhiều nhất năm 2024 (1đ).
SELECT G1.MAGIONG, LOAIVN
FROM GIONGVN G1
WHERE G1.MAGIONG IN (SELECT TOP 1 WITH TIES G2.MAGIONG
					 FROM GIONGVN G2, DOTCN D
					 WHERE G2.MAGIONG = D.MAGIONG AND G2.LOAIVN = G1.LOAIVN AND YEAR(NGBD) = 2024
					 GROUP BY G2.MAGIONG
					 ORDER BY SUM(SLVN) DESC)

---9. Tìm cơ sở chăn nuôi (MACS, TENCS) đã từng chăn nuôi tất cả các giống của loại vật nuôi “Heo” với số lượng chăn nuôi thực tế từ 20 vật nuôi trở lên (1đ).
SELECT MACS, TENCS
FROM CSCHANNUOI CSCN
WHERE NOT EXISTS (SELECT *
				  FROM GIONGVN GVN
				  WHERE LOAIVN = 'Heo' AND NOT EXISTS (SELECT *
													   FROM DOTCN DCN
													   WHERE DCN.MACS = CSCN.MACS AND DCN.MAGIONG = GVN.MAGIONG AND SLVN >= 20))